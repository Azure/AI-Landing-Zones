{
  "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json#",
  "view": {
    "kind": "Form",
    "properties": {
      "title": "AI/ML Landing Zone Deployment",
      "steps": [
        {
          "name": "basics",
          "label": "Basic Configuration",
          "elements": [
            {
              "name": "resourceScope",
              "type": "Microsoft.Common.ResourceScope",
              "location": {
                "resourceTypes": [
                  "Microsoft.Resources/resourceGroups"
                ]
              }
            },
            {
              "name": "baseName",
              "type": "Microsoft.Common.TextBox",
              "label": "Base Name",
              "defaultValue": "ailz",
              "toolTip": "Base name to seed resource names. This will be used as a prefix for all resources.",
              "placeholder": "Enter a base name (e.g., ailz, myproject)",
              "constraints": {
                "required": true,
                "regex": "^[a-z0-9]{2,12}$",
                "validationMessage": "Base name must be 2-12 characters long and contain only lowercase letters and numbers."
              },
              "visible": true
            },
            {
              "name": "platformLandingZone",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Platform Landing Zone Integration",
              "defaultValue": "No",
              "toolTip": "Enable if deploying into an existing platform landing zone that manages private DNS zones and private endpoints.",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": true
              }
            },
            {
              "name": "enableTelemetry",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Enable Telemetry",
              "defaultValue": "Yes",
              "toolTip": "Enable/Disable usage telemetry for the deployment.",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": true
              }
            }

          ]
        },
        {
          "name": "aiServices",
          "label": "AI Services Configuration",
          "elements": [
            {
              "name": "deployAiFoundry",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "AI Foundry Options",
              "defaultValue": "Full Setup",
              "toolTip": "Deploy Azure AI Foundry with default AI models",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Full Setup",
                    "value": "full"
                  },
                  {
                    "label": "Project Only",
                    "value": "project"
                  },
                  {
                    "label": "Custom",
                    "value": "custom"
                  }
                ],
                "required": true
              }
            },
            {
              "name": "deployAiSearch",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy AI Search",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure AI Search service",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
              },
              "visible": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"

            },
            {
              "name": "deployGroundingWithBing",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Bing Grounding",
              "defaultValue": "Yes",
              "toolTip": "Deploy Bing Search grounding capabilities",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
              },
              "visible": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
            },
            {
              "name": "deployCosmos",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Cosmos DB",
              "defaultValue": "Yes",
              "toolTip": "Deploy Cosmos DB",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
              },
              "visible": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
            },
            {
              "name": "deployKeyVault",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Key Vault",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure Key Vault",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
              },
              "visible": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
            },
            {
              "name": "deployStorageAccount",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Storage Account",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure Storage Account",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
              },
              "visible": "[equals(steps('aiServices').deployAiFoundry, 'custom')]"
            }
          ]
        },
        {
          "name": "applications", 
          "label": "Application Services Configuration",
          "elements": [
            {
              "name": "deployAppComponents",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "AI Application Options",
              "defaultValue": "Full Setup",
              "toolTip": "Deploy Azure Container Apps Environment and related components",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Full Setup",
                    "value": "full"
                  },
                  {
                    "label": "Custom",
                    "value": "custom"
                  }
                ],
                "required": true
              }
            },
            {
              "name": "deployAcr",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Azure Container Registry",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure Container Registry",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('applications').deployAppComponents, 'custom')]"
              },
              "visible": "[equals(steps('applications').deployAppComponents, 'custom')]"
            },
            {
              "name": "deployContainerAppEnv",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Azure Container Apps Environment",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure Container Apps Environment",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('applications').deployAppComponents, 'custom')]"
              },
              "visible": "[equals(steps('applications').deployAppComponents, 'custom')]"
            },
            {
              "name": "deployAppConfig",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Azure App Configuration",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure App Configuration",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('applications').deployAppComponents, 'custom')]"
              },
              "visible": "[equals(steps('applications').deployAppComponents, 'custom')]"
            },
            {
              "name": "deployApim",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Azure API Management",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure API Management",
                "constraints": {
                "allowedValues": [
                  {
                  "label": "Yes",
                  "value": "true"
                  },
                  {
                  "label": "No",
                  "value": "false"
                  }
                ],
                "required": "[and(equals(steps('applications').deployAppComponents, 'custom'), equals(steps('basics').platformLandingZone, 'false'))]"
              },
                "visible": "[and(equals(steps('applications').deployAppComponents, 'custom'), equals(steps('basics').platformLandingZone, 'false'))]"
            },
            {
              "name": "deployAppGateway",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Application Gateway",
              "defaultValue": "Yes",
              "toolTip": "Deploy Application Gateway for web application load balancing",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[and( equals(steps('basics').platformLandingZone, 'false'), equals(steps('applications').deployAppComponents, 'custom'))]"
              },
              "visible": "[and(equals(steps('basics').platformLandingZone, 'false'), equals(steps('applications').deployAppComponents, 'custom'))]"
            },
            {
              "name": "deployAppGatewayPip",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Application Gateway Public IP",
              "defaultValue": "Yes",
              "toolTip": "Deploy Application Gateway Public IP for network security",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[and(equals(steps('applications').deployAppGateway, 'true'), equals(steps('basics').platformLandingZone, 'false'))]"
              },
              "visible": "[and(equals(steps('applications').deployAppGateway, 'true'), equals(steps('basics').platformLandingZone, 'false'))]"
            } 
          ]
        },
        {
          "name": "devops",
          "label": "DevOps Configuration",
          "elements": [
            {
              "name": "deployCompute",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Virtual Machines",
              "defaultValue": "Yes",
              "toolTip": "Deploy required VMs to host runners for CI/CD build agents",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  },
                  {
                    "label": "Custom",
                    "value": "custom"
                  }                  
                ],
                "required": true
              }
            },
            {
              "name": "deployBuildVm",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Build Virtual Machine",
              "defaultValue": "Yes",
              "toolTip": "Deploy Build Virtual Machine",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('devops').deployCompute, 'custom')]"
              },
              "visible": "[equals(steps('devops').deployCompute, 'custom')]"
            },
            {
              "name": "deployJumpVm",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Jump Virtual Machine",
              "defaultValue": "Yes",
              "toolTip": "Deploy Jump Virtual Machine",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('devops').deployCompute, 'custom')]"
              },
              "visible": "[equals(steps('devops').deployCompute, 'custom')]"
            },
            {
              "name": "adminUsername",
              "type": "Microsoft.Common.TextBox",
              "label": "Username for Admin Access",
              "defaultValue": "adminuser",
              "toolTip": "Username for administrative access to the virtual machines",
              "constraints": {
                "required": "[or(equals(steps('devops').deployCompute, 'true'), equals(steps('devops').deployBuildVm, 'true'), equals(steps('devops').deployJumpVm, 'true'))]",
                "validationMessage": "Please enter a valid username for admin access",
                "regex": "^[a-zA-Z][a-zA-Z0-9_]{5,19}$"
              },
                "visible": "[or(equals(steps('devops').deployCompute, 'true'), equals(steps('devops').deployBuildVm, 'true'), equals(steps('devops').deployJumpVm, 'true'))]"
            },
            {
              "name": "adminPassword",
              "type": "Microsoft.Common.PasswordBox",
              "label": {
                "password": "Password for Admin Access",
                "confirmPassword": "Confirm Password"
              },
              "toolTip": "Password for administrative access to the virtual machines",
              "constraints": {
                "required": "[or(equals(steps('devops').deployCompute, 'true'), equals(steps('devops').deployBuildVm, 'true'), equals(steps('devops').deployJumpVm, 'true'))]",
                "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_\\-+=[\\]{}|\\\\:'\",.?`~\";]).{8,123}$",
                "validationMessage": "Your password must contain at least 8 characters, including at least one uppercase letter, one lowercase letter, one number, and one special character (@ # $ % ^ & * - _ ! + = [ ] { } | \\ : ' , . ? ` ~ \" ( ) ; )"
              },
              "options": {
                "hideConfirmation": false
              },
                "visible": "[or(equals(steps('devops').deployCompute, 'true'), equals(steps('devops').deployBuildVm, 'true'), equals(steps('devops').deployJumpVm, 'true'))]"
            },
            {
                "name": "vmSkuSize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "",
                "recommendedSizes": [
                    "Standard_D4as_v5",
                    "Standard_F4s_v2"
                ],
                "constraints": {
                  "numAvailabilityZonesRequired": 1,
                  "zone": "1"
                },
                "options": {
                    "hideDiskTypeFilter": false
                },
                "osPlatform": "Windows",
                "imageReference": {
                    "publisher": "MicrosoftWindowsServer",
                    "offer": "WindowsServer",
                    "sku": "2022-datacenter-azure-edition"
                },
                "count": 1,
                "visible": true
            }
          ]
        },
        {
          "name": "monitoring",
          "label": "Monitoring Configuration",
          "elements": [
            {
              "name": "deployMonitoring",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Monitoring Options",
              "defaultValue": "Full Setup",
              "toolTip": "Configure monitoring with Azure Monitor and Application Insights",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Full Setup",
                    "value": "full"
                  },
                  {
                    "label": "Custom",
                    "value": "custom"
                  }
                ],
                "required": true
              }
            },
            {
              "name": "deployLogAnalytics",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Log Analytics",
              "defaultValue": "Yes",
              "toolTip": "Deploy Log Analytics",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('monitoring').deployMonitoring, 'custom')]"
              },
              "visible": "[equals(steps('monitoring').deployMonitoring, 'custom')]"
            },
            {
              "name": "deployAppInsights",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Application Insights",
              "defaultValue": "Yes",
              "toolTip": "Deploy Application Insights",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('monitoring').deployMonitoring, 'custom')]"
              },
              "visible": "[equals(steps('monitoring').deployMonitoring, 'custom')]"
            }            
          ]
        },
        {
          "name": "networking",
          "label": "Network Configuration",
          "elements": [
            {
              "name": "deployFirewall",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Azure Firewall",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure Firewall for network security",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('basics').platformLandingZone, 'false')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'false')]"
            },
            {
              "name": "deployFirewallPip",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Azure Firewall Public IP",
              "defaultValue": "Yes",
              "toolTip": "Deploy Azure Firewall Public IP for network security",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[and(equals(steps('networking').deployFirewall, 'true'), equals(steps('basics').platformLandingZone, 'false'))]"
              },
              "visible": "[and(equals(steps('networking').deployFirewall, 'true'), equals(steps('basics').platformLandingZone, 'false'))]"
            },
            {

              "name": "deployVnet",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Virtual Network",
              "defaultValue": "Yes",
              "toolTip": "Deploy Virtual Network",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": true
              },
              "visible": true  
            },
          {
                "name": "vnetAddressSpace",
                "type": "Microsoft.Common.TextBox",
                "label": "Base IP address for the Virtual Network",
                "placeholder": "",
                "defaultValue": "192.168.0.0",
                "toolTip": "The base IP address for the IP Range",
                "constraints": {
                    "required": "[equals(steps('networking').deployVnet, 'true')]",
                    "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){2}0\\.0$",
                    "validationMessage": "Please enter a valid Base IP Address (e.g., 192.168.0.0)."
                },
                "visible": "[equals(steps('networking').deployVnet, 'true')]"
            },
            {
              "name": "existingVnet",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Virtual Network",
              "resourceType": "Microsoft.Network/virtualNetworks",
              "toolTip": "Select virtual network to use for the landing zone.",
              "constraints": {
                "required": "[equals(steps('networking').deployVnet, 'false')]"
              },
              "visible": "[equals(steps('networking').deployVnet, 'false')]"
            },
            {
              "name": "createSubnets",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Deploy Subnets",
              "defaultValue": "Yes",
              "toolTip": "Deploy Subnets?",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": "[equals(steps('networking').deployVnet, 'false')]"
              },
              "visible": "[equals(steps('networking').deployVnet, 'false')]"  
            },
            {
                "name": "subNetProvidersApi",
                "type": "Microsoft.Solutions.ArmApiControl",
                "request": {
                  "method": "GET",
                  "path": "[concat(substring(steps('networking').existingVnet.id,0,length(steps('networking').existingVnet.id)),'/subnets?api-version=2024-05-01')]"
                }
            },
              {
                "name": "agentSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Agent subnet",
                "toolTip": "Select subnet for Agents",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[equals(steps('networking').createSubnets,'false')]"
                },
                "visible": "[equals(steps('networking').createSubnets,'false')]"
              },
              {
                "name": "privateEndpointSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Private Endpoint subnet",
                "toolTip": "Select subnet for Private Endpoint",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[equals(steps('networking').createSubnets,'false')]"
                },
                "visible": "[equals(steps('networking').createSubnets,'false')]"
              },
              {
                "name": "azureBastionSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Azure Bastion Subnet",
                "toolTip": "Select subnet for Azure Bastion",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'))]"
                },
                "visible": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'))]"
              },
              {
                "name": "azureFirewallSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Azure Firewall Subnet",
                "toolTip": "Select subnet for Azure Firewall",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'))]"
                },
                "visible": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'), equals(steps('networking').deployFirewall, 'true'))]"
              },
              {
                "name": "appGatewaySubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "App Gateway Subnet",
                "toolTip": "Select subnet for App Gateway",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'), or(equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAppGateway, 'true')))]"
                },
                "visible": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'), or(equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAppGateway, 'true')))]"
              },
              {
                "name": "apimSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "APIM Subnet",
                "toolTip": "Select subnet for APIM",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'))]"
                },
                "visible": "[and( equals(steps('networking').createSubnets,'false'), equals(steps('basics').platformLandingZone,'false'), or(equals(steps('applications').deployApim, 'true'), equals(steps('applications').deployAppComponents, 'full')))]"
              },
              {
                "name": "jumpBoxSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Jump Box Subnet",
                "toolTip": "Select subnet for Jump Box",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[and( equals(steps('networking').createSubnets,'false'), or(equals(steps('devops').deployJumpVm, 'true'), equals(steps('devops').deployCompute, 'true')))]"
                },
                "visible": "[and( equals(steps('networking').createSubnets,'false'), or(equals(steps('devops').deployJumpVm, 'true'), equals(steps('devops').deployCompute, 'true')))]"
              },
              {
                "name": "containerEnvSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Subnet for Azure Container Apps Environment",
                "toolTip": "Select subnet for Azure Container Apps Environment",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[and( equals(steps('networking').createSubnets,'false'), or( equals(steps('applications').deployContainerAppEnv, 'true'), equals(steps('applications').deployAppComponents, 'full') ))]"
                },
                "visible": "[and( equals(steps('networking').createSubnets,'false'), or( equals(steps('applications').deployContainerAppEnv, 'true'), equals(steps('applications').deployAppComponents, 'full') ))]"
              },
              {
                "name": "devopsAgentsSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Subnet for DevOps Agents",
                "toolTip": "Select subnet for DevOps Agents",
                "constraints": {
                  "allowedValues": "[map(steps('networking').subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": "[and( equals(steps('networking').createSubnets,'false'), or(equals(steps('devops').deployCompute, 'true'), equals(steps('devops').deployBuildVm, 'true')))]"
                },
                "visible": "[and( equals(steps('networking').createSubnets,'false'), or(equals(steps('devops').deployCompute, 'true'), equals(steps('devops').deployBuildVm, 'true')))]"
              },
          {
                "name": "appGwPrivateIp",
                "type": "Microsoft.Common.TextBox",
                "label": "Static IP Address for Application Gateway",
                "placeholder": "",
                "defaultValue": "192.168.0.200",
                "toolTip": "The private IP address for the Application Gateway",
                "constraints": {
                    "required": "[and( equals(steps('basics').platformLandingZone,'false'), or(equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAppGateway, 'true')))]",
                    "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$",
                    "validationMessage": "Please enter a valid IP Address (e.g., 192.168.0.200)."
                },
                "visible": "[and( equals(steps('basics').platformLandingZone,'false'), or(equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAppGateway, 'true')))]"
            },
            {
              "name": "deployPeering",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Peer to an existing virtual network?",
              "defaultValue": "No",
              "toolTip": "Deploy Virtual Network Peering",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "true"
                  },
                  {
                    "label": "No",
                    "value": "false"
                  }
                ],
                "required": true
              },
              "visible": true  
            },
            {
              "name": "peerVnet",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Virtual Network for peering",
              "resourceType": "Microsoft.Network/virtualNetworks",
              "toolTip": "Select virtual network to peer with.",
              "constraints": {
                "required": "[equals(steps('networking').deployPeering, 'true')]"
              },
              "visible": "[equals(steps('networking').deployPeering, 'true')]"
            },
            {
              "name": "cognitiveServicesPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Cognitive Services",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Cognitive Services private endpoints",
              "constraints": {
                "required": "[equals(steps('basics').platformLandingZone, 'true')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'true')]"
            },
            {
              "name": "openaiPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for OpenAI",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for OpenAI private endpoints",
              "constraints": {
                "required": "[equals(steps('basics').platformLandingZone, 'true')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'true')]"
            },
            {
              "name": "aiServicesPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for AI Services",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for AI Services private endpoints",
              "constraints": {
                "required": "[equals(steps('basics').platformLandingZone, 'true')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'true')]"
            },
            {
              "name": "searchPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure AI Search",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure AI Search private endpoints",
              "constraints": {
                "required": "[equals(steps('basics').platformLandingZone, 'true')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'true')]"
            },
            {
              "name": "cosmosSqlPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure Cosmos DB",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure Cosmos DB private endpoints",
              "constraints": {
                "required": "[equals(steps('basics').platformLandingZone, 'true')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'true')]"
            },
            {
              "name": "blobPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure Blob Storage",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure Blob Storage private endpoints",
              "constraints": {
                "required": "[equals(steps('basics').platformLandingZone, 'true')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'true')]"
            },
            {
              "name": "keyVaultPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure Key Vault",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure Key Vault private endpoints",
              "constraints": {
                "required": "[equals(steps('basics').platformLandingZone, 'true')]"
              },
              "visible": "[equals(steps('basics').platformLandingZone, 'true')]"
            },
            {
              "name": "appConfigPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure App Configuration",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure App Configuration private endpoints",
              "constraints": {
              "required": "[and(equals(steps('basics').platformLandingZone, 'true'), or( equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAppConfig, 'true') ) )]"
              },
              "visible": "[and(equals(steps('basics').platformLandingZone, 'true'), or( equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAppConfig, 'true') ) )]"
            },
            {
              "name": "containerAppsPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure Container Apps",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure Container Apps private endpoints",
              "constraints": {
                "required": "[and(equals(steps('basics').platformLandingZone, 'true'), or( equals(steps('applications').deployAppComponents, 'full') ,equals(steps('applications').deployContainerAppEnv, 'true')))]"
              },
              "visible": "[and(equals(steps('basics').platformLandingZone, 'true'), or( equals(steps('applications').deployAppComponents, 'full') ,equals(steps('applications').deployContainerAppEnv, 'true')))]"
            },
            {
              "name": "acrPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure Container Registry",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure Container Registry private endpoints",
                "constraints": {
                "required": "[and(equals(steps('basics').platformLandingZone, 'true'), or( equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAcr, 'true')))]"
              },
              "visible": "[and(equals(steps('basics').platformLandingZone, 'true'), or( equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployAcr, 'true')))]"
            },
            {
              "name": "appInsightsPrivateDnsZone",
              "type": "Microsoft.Solutions.ResourceSelector",
              "label": "Select Azure Private DNS Zone for Azure Application Insights",
              "resourceType": "Microsoft.network/privateDnsZones",
              "toolTip": "Select an existing DNS zone for Azure Application Insights private endpoints",
                "constraints": {
                "required": "[and(equals(steps('basics').platformLandingZone, 'true'), equals(steps('monitoring').deployAppInsights, 'true'))]"
                },
              "visible": "[and(equals(steps('basics').platformLandingZone, 'true'), equals(steps('monitoring').deployAppInsights, 'true'))]"
            }
          ]
        },
        {
          "name": "Tags",
          "label": "Tags",
          "elements": [
                        {
                            "name": "tagsByResource",
                            "type": "Microsoft.Common.TagsByResource",
                            "resources": [
                                "Microsoft.Storage/storageAccounts",
                                "Microsoft.Compute/virtualMachines"
                            ]
                        }
          ]
        }

      ]
    },
    "outputs": {
      "kind": "ResourceGroup",
      "location": "[steps('basics').resourceScope.location.name]",
      "resourceGroupId": "[steps('basics').resourceScope.resourceGroup.id]",
      "parameters": {
        "deployToggles": {
          "acaEnvironmentNsg": "[and(or(equals(steps('networking').createSubnets, 'true'),  equals(steps('networking').deployVnet, 'true') ) , or (equals(steps('applications').deployAppComponents, 'full'), equals(steps('applications').deployContainerAppEnv, 'true')) )]",
          "agentNsg": "[or(equals(steps('networking').createSubnets, 'true'),  equals(steps('networking').deployVnet, 'true') )]",
          "apiManagement": "[and(or(equals(steps('applications').deployApim, 'true'), equals(steps('applications').deployAppComponents, 'full')), equals(steps('basics').platformLandingZone, 'false'))]",
          "apiManagementNsg": "[and( or(equals(steps('networking').createSubnets, 'true'),  equals(steps('networking').deployVnet, 'true') ) , and(or(equals(steps('applications').deployApim, 'true'), equals(steps('applications').deployAppComponents, 'full')), equals(steps('basics').platformLandingZone, 'false')))]",
          "appConfig": "[or(equals(steps('applications').deployAppConfig, 'true'), equals(steps('applications').deployAppComponents, 'full'))]",
          "appInsights": "[or( equals(steps('monitoring').deployAppInsights, 'true'), equals(steps('monitoring').deployMonitoring, 'full'))]",
          "applicationGateway": "[and(or(equals(steps('applications').deployAppGateway, 'true'), equals(steps('applications').deployAppComponents, 'full')), equals(steps('basics').platformLandingZone, 'false'))]",
          "applicationGatewayNsg": "[and( or(equals(steps('networking').createSubnets, 'true'),  equals(steps('networking').deployVnet, 'true')) , and(or(equals(steps('applications').deployAppGateway, 'true'), equals(steps('applications').deployAppComponents, 'full')), equals(steps('basics').platformLandingZone, 'false')))]",
          "applicationGatewayPublicIp": "[and(or(equals(steps('applications').deployAppGatewayPip, 'true'), equals(steps('applications').deployAppComponents, 'full')), equals(steps('basics').platformLandingZone, 'false'))]",
          "bastionHost": "[equals(steps('basics').platformLandingZone, 'false')]",
          "wafPolicy": "[and(or(equals(steps('applications').deployAppGateway, 'true'), equals(steps('applications').deployAppComponents, 'full')), equals(steps('basics').platformLandingZone, 'false'))]",
          "buildVm": "[or( equals(steps('devops').deployBuildVm, 'true'), equals(steps('devops').deployCompute, 'true'))]",
          "containerApps": "[or( equals(steps('applications').deployContainerAppEnv, 'true'), equals(steps('applications').deployAppComponents, 'full'))]",
          "containerEnv": "[or( equals(steps('applications').deployContainerAppEnv, 'true'), equals(steps('applications').deployAppComponents, 'full'))]",
          "containerRegistry": "[or( equals(steps('applications').deployAcr, 'true'), equals(steps('applications').deployAppComponents, 'full'))]",
          "cosmosDb": "[or( equals(steps('aiServices').deployCosmos, 'true'), equals(steps('aiServices').deployAiFoundry, 'full'))]",
          "devopsBuildAgentsNsg": "[or(equals(steps('networking').createSubnets, 'true'),  equals(steps('networking').deployVnet, 'true') )]",
          "firewall": "[and(equals(steps('networking').deployFirewall, 'true'), equals(steps('basics').platformLandingZone, 'false'))]",
          "firewallPublicIp": "[and(equals(steps('networking').deployFirewallPip, 'true'), equals(steps('basics').platformLandingZone, 'false'))]",
          "groundingWithBingSearch": "[or( equals(steps('aiServices').deployGroundingWithBing, 'true'), equals(steps('aiServices').deployAiFoundry, 'full'))]",
          "jumpVm": "[or( equals(steps('devops').deployJumpVm, 'true'), equals(steps('devops').deployCompute, 'true'))]",
          "jumpboxNsg": "[and(or(equals(steps('networking').createSubnets, 'true'),  equals(steps('networking').deployVnet, 'true') ), or( equals(steps('devops').deployJumpVm, 'true'), equals(steps('devops').deployCompute, 'true')))]",
          "keyVault": "[or( equals(steps('aiServices').deployKeyVault, 'true'), equals(steps('aiServices').deployAiFoundry, 'full'))]",
          "logAnalytics": "[or( equals(steps('monitoring').deployLogAnalytics, 'true'), equals(steps('monitoring').deployMonitoring, 'full'))]",
          "peNsg": "[and( equals(steps('basics').platformLandingZone, 'false'),or(equals(steps('networking').createSubnets, 'true'),  equals(steps('networking').deployVnet, 'true') ))]",
          "searchService": "[or( equals(steps('aiServices').deployAiSearch, 'true'), equals(steps('aiServices').deployAiFoundry, 'full'))]",
          "storageAccount": "[or( equals(steps('aiServices').deployStorageAccount, 'true'), equals(steps('aiServices').deployAiFoundry, 'full'))]",
          "virtualNetwork": "[equals(steps('networking').deployVnet, 'true')]",
          "bastionNsg": "[equals(steps('basics').platformLandingZone, 'false')]"
        },
        "flagPlatformLandingZone": "[equals(steps('basics').platformLandingZone, 'true')]",
        "deployPeering": "[equals(steps('networking').deployPeering, 'true')]",
        "enableTelemetry": "[equals(steps('basics').enableTelemetry, 'true')]", 
        "baseName": "[steps('basics').baseName]",
        "vnetBaseAddress": "[steps('networking').vnetAddressSpace]",
        "existingSubnets": {
          "agentSubnet": "[coalesce(steps('networking').agentSubnet, '')]",
          "peSubnet": "[coalesce(steps('networking').privateEndpointSubnet, '')]",
          "bastionSubnet": "[coalesce(steps('networking').azureBastionSubnet, '')]",
          "firewallSubnet": "[coalesce(steps('networking').azureFirewallSubnet, '')]",
          "appGwSubnet": "[coalesce(steps('networking').appGatewaySubnet, '')]",
          "apimSubnet": "[coalesce(steps('networking').apimSubnet, '')]",
          "acaEnvSubnet": "[coalesce(steps('networking').containerEnvSubnet, '')]",
          "jumpboxSubnet": "[coalesce(steps('networking').jumpBoxSubnet, '')]",
          "devopsSubnet": "[coalesce(steps('networking').devopsAgentsSubnet, '')]"
        },
        "vmadmin": "[coalesce(steps('devops').adminUsername, '')]",
        "vmPassword": "[coalesce(steps('devops').adminPassword, '')]",
        "vmSize": "[coalesce(steps('devops').vmSkuSize, 'Standard_D4as_v5')]",
        "existingVnetName": "[if(equals(steps('networking').deployVnet, 'false'), steps('networking').existingVnet.name, '')]",
        "existingVnetId": "[if(equals(steps('networking').deployVnet, 'false'), steps('networking').existingVnet.id, '')]",
        "appGwPrivateIp" : "[coalesce(steps('networking').appGwPrivateIp, '')]",
        "peerVnetId": "[if(equals(steps('networking').deployPeering, 'true'), steps('networking').peerVnet.id, '')]",
        "peerVnetName": "[if(equals(steps('networking').deployPeering, 'true'), steps('networking').peerVnet.name, '')]",
        "existingDNSZones": {
          "cognitiveservicesZoneId": "[coalesce(steps('networking').cognitiveServicesPrivateDnsZone.id, '')]",
          "openaiZoneId": "[coalesce(steps('networking').openaiPrivateDnsZone.id, '')]",
          "aiServicesZoneId": "[coalesce(steps('networking').aiServicesPrivateDnsZone.id, '')]",
          "searchZoneId": "[coalesce(steps('networking').searchPrivateDnsZone.id, '')]",
          "cosmosSqlZoneId": "[coalesce(steps('networking').cosmosSqlPrivateDnsZone.id, '')]",
          "blobZoneId": "[coalesce(steps('networking').blobPrivateDnsZone.id, '')]",
          "keyVaultZoneId": "[coalesce(steps('networking').keyVaultPrivateDnsZone.id, '')]",
          "appConfigZoneId": "[coalesce(steps('networking').appConfigPrivateDnsZone.id, '')]",
          "containerAppsZoneId": "[coalesce(steps('networking').containerAppsPrivateDnsZone.id, '')]",
          "acrZoneId": "[coalesce(steps('networking').acrPrivateDnsZone.id, '')]",
          "appInsightsZoneId": "[coalesce(steps('networking').appInsightsPrivateDnsZone.id, '')]"
        },
        "tags": {
            "Project": "AI-ML-Landing-Zone",
            "DeployedBy": "UI-Form",
            "BaseName": "[steps('basics').baseName]"
        }
      }
    }
  }
}